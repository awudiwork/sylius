# Sylius 端口模式配置（合并版 - 性能优化版）
# 前台端口: 8090
# 后台端口: 8091
# 更新日期: 2025-10-15
# 优化内容: 启用 HTTP/1.1 持久连接、gzip 压缩、代理缓冲优化

# ========================================
# 前台商城 (端口 8090)
# ========================================
server {
    listen 8090;
    server_name _;  # 接受任何域名/IP

    # 日志文件
    access_log /var/log/nginx/sylius-frontend-access.log;
    error_log /var/log/nginx/sylius-frontend-error.log;

    # 客户端上传文件大小限制
    client_max_body_size 20M;

    # 客户端缓冲区设置
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # ========== 性能优化：Gzip 压缩 ==========
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    gzip_min_length 1000;

    # 禁止从前台访问后台路径（安全加固）
    location ^~ /admin {
        return 404;
    }

    # ========== 处理 /media/ 路径（图片、上传文件等）==========
    location ~* ^/media/ {
        proxy_pass http://127.0.0.1:8080;

        # 性能优化：启用 HTTP/1.1 持久连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # 请求头设置
        proxy_set_header Host localhost;  # 修改为 localhost，匹配容器内 Nginx
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 性能优化：启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        proxy_temp_file_write_size 8k;

        # 超时设置（图片处理可能需要更长时间）
        proxy_connect_timeout 60;
        proxy_send_timeout 120;
        proxy_read_timeout 120;
    }

    # ========== 静态资源缓存优化（/build/ 编译后的资源）==========
    location ~* ^/build/.*\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|map)$ {
        proxy_pass http://127.0.0.1:8080;

        # 性能优化
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host localhost;

        # 启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # 长期缓存
        expires 365d;
        add_header Cache-Control "public, immutable";

        # 忽略后端的缓存控制头
        proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
        proxy_hide_header "Set-Cookie";
    }

    # ========== 所有请求反向代理到容器（由 Symfony 处理路由）==========
    location / {
        proxy_pass http://127.0.0.1:8080;

        # 性能优化：启用 HTTP/1.1 持久连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # 请求头设置
        proxy_set_header Host localhost;  # 修改为 localhost，匹配容器内 Nginx
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 性能优化：启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 24 4k;
        proxy_busy_buffers_size 8k;
        proxy_temp_file_write_size 8k;

        # 超时设置
        proxy_connect_timeout 60;
        proxy_send_timeout 60;
        proxy_read_timeout 60;
    }
}

# ========================================
# 后台管理 (端口 8091)
# ========================================
server {
    listen 8091;
    server_name _;  # 接受任何域名/IP

    # 日志文件
    access_log /var/log/nginx/sylius-backend-access.log;
    error_log /var/log/nginx/sylius-backend-error.log;

    # 客户端上传文件大小限制
    client_max_body_size 20M;

    # 客户端缓冲区设置
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # ========== 性能优化：Gzip 压缩 ==========
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
    gzip_min_length 1000;

    # IP 白名单（可选 - 增强安全性）
    # 取消注释下面几行来启用 IP 限制
    # allow 192.168.1.0/24;    # 允许局域网
    # allow 1.2.3.4;           # 允许特定 IP
    # deny all;                # 拒绝其他所有 IP

    # 基本认证（可选 - 双重保护）
    # 取消注释下面几行来启用基本认证
    # auth_basic "Admin Area - Restricted Access";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # ========== 处理 /media/ 路径（图片、上传文件等）==========
    location ~* ^/media/ {
        proxy_pass http://127.0.0.1:8080;

        # 性能优化：启用 HTTP/1.1 持久连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # 请求头设置
        proxy_set_header Host localhost;  # 修改为 localhost，匹配容器内 Nginx
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 性能优化：启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        proxy_temp_file_write_size 8k;

        # 超时设置（图片处理可能需要更长时间）
        proxy_connect_timeout 60;
        proxy_send_timeout 120;
        proxy_read_timeout 120;
    }

    # ========== 静态资源缓存优化 ==========
    location ~* ^/build/.*\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|map)$ {
        proxy_pass http://127.0.0.1:8080;

        # 性能优化
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host localhost;

        # 启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # 长期缓存
        expires 365d;
        add_header Cache-Control "public, immutable";

        # 忽略后端的缓存控制头
        proxy_ignore_headers "Set-Cookie" "Cache-Control" "Expires";
        proxy_hide_header "Set-Cookie";
    }

    # ========== 反向代理到 Docker 容器 ==========
    location / {
        # 将根路径请求重定向到 /admin/
        if ($request_uri = /) {
            return 302 /admin/;
        }

        proxy_pass http://127.0.0.1:8080;

        # 性能优化：启用 HTTP/1.1 持久连接
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # 请求头设置
        proxy_set_header Host localhost;  # 修改为 localhost，匹配容器内 Nginx
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # 性能优化：启用代理缓冲（后台上传表单可能较大）
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 32 4k;
        proxy_busy_buffers_size 16k;
        proxy_temp_file_write_size 16k;

        # 超时设置（后台操作可能需要更长时间）
        proxy_connect_timeout 60;
        proxy_send_timeout 120;
        proxy_read_timeout 120;
    }
}
